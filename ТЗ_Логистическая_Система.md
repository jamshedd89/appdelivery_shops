# Техническое задание (ТЗ)

## Мобильное приложение логистической системы (аналог Яндекс Доставка)

## 1. Общая информация

**Цель проекта:**\
Разработка мобильного приложения для организации доставки товаров между
продавцами и курьерами с использованием геолокации, системы рейтингов и
безопасных платежей.

**Платформы:**

-   Android
-   iOS

**Типы пользователей:**

-   Продавец
-   Курьер

## 1.1 Технологический стек (обязательные требования)

### Карты и геолокация

-   Используется **Yandex Map API**
-   Отображение:
    -   адресов магазинов и клиентов
    -   местоположения курьеров в реальном времени

### Frontend

-   **React Native**
-   **React**
-   Поддержка Android и iOS из единой кодовой базы

### Backend

-   **Node.js** **Express.js**
-   REST API архитектура

### База данных и ORM

-   Реляционная БД (MySQL)
-   **Sequelize ORM**

## 2. Регистрация и авторизация

### 2.1 Общие требования

-   Регистрация осуществляется **по номеру телефона**.
-   Подтверждение номера через **SMS-код (OsonSms -- \* пока нет апи)**.
-   Перед регистрацией пользователь **обязательно выбирает роль**:
    -   Продавец
    -   Курьер

### 2.2 Регистрация продавца

Обязательные поля:

-   Имя
-   Фамилия
-   Дата рождения
-   Адрес магазина или склада
-   Указание адреса **на карте (обязательно)**

Функционал:

-   Возможность указывать один или несколько адресов складов
-   Адрес используется как точка старта для поиска курьеров

### 2.3 Регистрация курьера

Обязательные данные:

-   Имя
-   Фамилия
-   Год рождения
-   Фото паспорта (лицевая и обратная сторона)
-   Фото лица с паспортом
-   ИНН
-   Наличие транспорта:
    -   Пешком
    -   Велосипед
    -   Мото
    -   Авто

Требования:

-   Тип транспорта **отображается продавцу**
-   Продавец может **отказаться от курьера** из-за неподходящего
    транспорта
-   Данные курьера проходят модерацию

## 3. Функционал продавца

### 3.1 Создание заявки на доставку

Продавец может создать заявку, указав:

-   Адрес магазина/склада (автоматически)
-   До **10 товаров** в одной заявке
-   У каждого товара может быть **разный адрес доставки**
-   Адрес клиента (обязательно)
-   Стоимость доставки (минимум **10 сомони**)

### 3.2 Работа с курьером

-   После создания заявки система ищет курьеров поблизости
-   Курьер может выбрать:
    -   Минимум 1 товар
    -   Максимум --- по собственному усмотрению

**Важно:**

-   Если курьер принял заявку и **прибыл в магазин**, но продавец
    отменил заказ --- ➜ продавец оплачивает **50% от стоимости
    доставки**

## 4. Функционал курьера

### 4.1 Работа с заявками

-   При входе в приложение курьер автоматически становится **Online**
-   Обязательно разрешение **геолокации**
-   На главном экране:
    -   Карта
    -   Список активных заявок

Ограничения:

-   Показываются заявки в радиусе **до 3 км**
-   Каждые **5 минут** приходят уведомления о новых заявках
-   Курьер может:
    -   Принять заявку
    -   Отказаться
    -   Выбрать из списка вручную

### 4.2 Таймер доставки

-   На каждую доставку устанавливается **таймер 90 минут**
-   При опоздании курьер обязан указать причину
-   Причина отображается продавцу

Система анализа:

-   Частые опоздания → меньше заявок
-   Улучшение показателей → восстановление стандартного потока заказов

### 4.3 Рейтинг курьера

-   Начальный уровень: **50**
-   Максимум: **100**

Влияние рейтинга:

-   \< 50 --- меньше заказов

-   = 50 --- стандартные заказы

-   50 --- больше заказов

-   100 --- приоритетный доступ к заявкам

## 5. Система рейтингов и отзывов

### 5.1 Общие правила

-   Продавец оценивает курьера
-   Курьер оценивает продавца
-   Формат:
    -   Модальное окно
    -   1--5 звёзд
    -   Комментарий (необязательно)
    -   Кнопка закрытия (X)

Ограничения:

-   Нельзя редактировать или удалять отзыв

### 5.2 Начальные значения

-   По умолчанию у всех **5 звёзд**
-   Рейтинг меняется динамически на основе отзывов

### 5.3 Отображение рейтингов

-   Продавец видит рейтинг курьера **до принятия заявки**
-   Курьер видит рейтинг продавца **до принятия заказа**
-   Обе стороны могут отказаться от сотрудничества

## 6. Система оплаты и баланса

### 6.1 Баланс и заморозка средств

-   При создании заявки у продавца должна быть достаточная сумма на
    балансе
-   Если средств недостаточно:
    -   Появляется кнопка «Пополнить баланс»

Процесс:

1.  Сумма доставки **замораживается**
2.  С баланса списывается **5 сомони (комиссия сервиса)**
3.  Средства хранятся на счёте сервиса

### 6.2 Подтверждение доставки

-   Курьер отмечает заказ как доставленный
-   Продавец подтверждает доставку
-   Таймер подтверждения: **20 минут**
-   Если продавец не подтвердил --- заказ подтверждается автоматически

После подтверждения:

-   Деньги переводятся на баланс курьера

### 6.3 Пополнение и вывод средств

Доступные способы:

-   Alif Mobi
-   Душанбе Сити

Ограничения:

-   И продавец, и курьер могут пополнять и выводить средства

### 6.4 Наличные расчёты

-   Если клиент хочет оплатить товар **наличными**:
    -   Курьер **не имеет права принимать деньги**
    -   Курьер обязан попросить клиента связаться с продавцом

Ответственность:

-   Сервис **не несёт ответственности** за потери денег между продавцом
    и курьером
-   Все договорённости по стоимости товара --- между сторонами

## 7. Безопасность и модерация

-   Проверка документов курьеров
-   Логи всех действий
-   История заказов
-   Антифрод-контроль

## 8. Будущие доработки (опционально)

-   Веб-админка
-   Система штрафов
-   Подписки для продавцов
-   AI-анализ поведения курьеров

## 9. Статусы пользователей

### 9.1 Статусы курьера

-   На модерации
-   Активен
-   Временно ограничен
-   Заблокирован

### 9.2 Статусы продавца

-   Активен
-   Ограничен
-   Заблокирован

## 10. Статусы заявок (жизненный цикл)

1.  Создана
2.  Ожидает курьера
3.  Принята курьером
4.  Курьер в пути к магазину
5.  Курьер на месте
6.  В пути к клиенту
7.  Доставлено
8.  Подтверждено продавцом
9.  Завершено
10. Отменено продавцом
11. Отменено курьером
12. Истёк таймер

## 11. Причины отказа и отмен

### 11.1 Курьер

-   Не подходит транспорт
-   Слишком далеко
-   Занят
-   Другая причина (обязательно описание)

### 11.2 Продавец

-   Клиент отменил
-   Ошибка в адресе
-   Нет товара
-   Другая причина (обязательно описание)

## 12. Система штрафов и ограничений

### 12.1 Курьер

-   3 опоздания → −5 к рейтингу
-   5 отмен подряд → блокировка на 24 часа
-   Частые отказы → уменьшение радиуса показа заявок

### 12.2 Продавец

-   Частые отмены после принятия → повышенная комиссия
-   Фейковые заявки → временная блокировка

## 13. Геолокация и трекинг

-   Обновление координат курьера каждые 15--30 секунд
-   Отображение движения курьера на карте продавцу
-   Лог последней активности курьера

## 14. Встроенный чат

-   Чат между продавцом и курьером
-   Активен только во время активного заказа
-   Поддержка текста, фото и геолокации

## 15. Push-уведомления

-   Новая заявка
-   Принятие / отказ
-   Курьер на месте
-   Заказ доставлен
-   Истечение таймера
-   Отмена заказа
-   Изменение рейтинга
-   Финансовые операции

## 16. Админ-панель

-   Управление пользователями
-   Проверка документов курьеров
-   Управление заказами
-   Финансы и комиссии
-   Жалобы и блокировки

## 17. Финансовые ограничения

-   Минимальный вывод средств (например 50 сомони)
-   Комиссия за вывод
-   Сроки вывода средств (T+1, T+3)
-   История транзакций

## 18. Юридическая часть

-   Пользовательское соглашение
-   Политика конфиденциальности
-   Согласие на обработку персональных данных
-   Отказ от ответственности за наличные расчёты

## 19. Этапы запуска

### MVP

-   Регистрация
-   Заявки
-   Карта
-   Баланс
-   Рейтинг

### Версия 2

-   Чат
-   Штрафы
-   Подписки
-   Аналитика

## 20. Монетизация проекта (после успешного запуска MVP)

Данный раздел активируется **после того, как MVP показал спрос,
стабильные заказы и рост пользователей**.

### 20.1 Комиссия с каждой доставки (базовая модель)

-   Фиксированная комиссия сервиса: **5 сомони с каждого заказа**
-   Дополнительно может применяться процент от стоимости доставки:
    -   от **5% до 10%**

**Пример:** Стоимость доставки: 30 сомони\
Комиссия сервиса: 5 сомони + 3 сомони (10%) = **8 сомони**

### 20.2 Подписки для продавцов (основной источник дохода)

#### Free (по умолчанию)

-   Ограниченное количество заявок
-   Стандартный показ курьерам
-   Базовая комиссия

#### Pro (платная подписка)

-   Стоимость: **99 сомони / месяц**
-   Увеличенный лимит заявок
-   Приоритетный показ курьерам
-   Пониженная комиссия
-   Расширенная аналитика заказов

### 20.3 Приоритет для курьеров (Boost)

-   Курьер может оплатить приоритетный доступ
-   Стоимость: **10--20 сомони**
-   Срок действия: **24 часа**

Преимущества:

-   Получение заявок раньше других
-   Повышенный шанс принятия заказов

### 20.4 Повышенные комиссии за нарушения

#### Для продавцов:

-   Частые отмены заказов после принятия курьером → повышенная комиссия
-   Систематические нарушения → временные ограничения

#### Для курьеров:

-   Частые опоздания → снижение количества заявок
-   Возможность платного восстановления стандартного потока заказов

### 20.5 Комиссия за вывод средств

-   Минимальная сумма вывода: **50 сомони**
-   Комиссия:
    -   до 100 сомони → **3%**
    -   свыше 100 сомони → **1.5%**

### 20.6 Корпоративные клиенты (B2B)

-   Магазины, аптеки, рестораны, склады
-   Индивидуальные договоры
-   Фиксированная абонентская плата
-   Приоритетные курьеры
-   Персональные условия

### 20.7 Реклама и продвижение внутри приложения (этап масштабирования)

-   Продвижение продавцов в топе района
-   Рекомендованные магазины
-   Рекламные блоки

Реализуется **только после достижения активной пользовательской базы**.

### 20.8 Прогноз доходности (ориентировочно)

Пример:

-   100 доставок в день
-   Средняя комиссия: 7 сомони

Доход:

-   700 сомони в день
-   \~21 000 сомони в месяц (без учёта подписок и доп. сервисов)

**Конец ТЗ**

Дополнение к Техническому заданию

1\. WebSocket (реальное обновление карты)

Для обеспечения обновления местоположения курьеров в реальном времени
используется WebSocket-соединение между мобильным приложением и
сервером.

Функциональность:

• Обновление координат курьера каждые 15--30 секунд

• Мгновенное отображение движения курьера на карте продавца

• Обновление статусов заказа без перезагрузки приложения

• Реальные push-события внутри приложения

Рекомендуемая реализация:

• Socket.io на базе Node.js

• Авторизация через JWT

• Отдельный namespace для заказов

2\. Redis (радиусный поиск курьеров)

Для быстрого поиска курьеров в радиусе до 3 км используется Redis с
гео-индексами.

Функциональность:

• GEOADD --- сохранение координат курьеров

• GEORADIUS --- поиск курьеров рядом с магазином

• Автоматическое удаление неактивных курьеров

Преимущества:

• Высокая скорость поиска (миллисекунды)

• Снижение нагрузки на MySQL

• Масштабируемость при росте пользователей

3\. Очередь задач (BullMQ)

Для обработки фоновых задач и уведомлений используется очередь BullMQ на
базе Redis.

Задачи для очереди:

• Отправка push-уведомлений

• Проверка таймера 90 минут

• Автоматическое подтверждение через 20 минут

• Обработка штрафов и рейтингов

Преимущества:

• Отказоустойчивость

• Возможность повторной обработки задач

• Масштабирование через worker-процессы

4\. Отдельный микросервис для платежей

Финансовая логика выносится в отдельный микросервис для обеспечения
безопасности и изоляции транзакций.

Функции микросервиса:

• Заморозка средств при создании заявки

• Списание комиссии сервиса

• Перевод средств курьеру после подтверждения

• История транзакций (ledger)

• Вывод средств (T+1 / T+3)

Рекомендации по архитектуре:

• Отдельная база данных для финансов

• Двойная запись (Debit / Credit)

• Логирование всех операций

• REST API между основным backend и платежным сервисом

Итоговая архитектура

Mobile App → API Gateway → Основной Backend → Redis (гео + очередь) →
WebSocket → Платежный микросервис → MySQL
